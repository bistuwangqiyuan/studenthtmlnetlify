# å­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿ - å®Œæ•´å¼€å‘æ“ä½œæ¸…å•

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è®°å½•äº†ä»é›¶å¼€å§‹æ„å»ºå¹¶éƒ¨ç½²å­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿçš„å®Œæ•´è¿‡ç¨‹ï¼ŒåŒ…æ‹¬æ‰€æœ‰é…ç½®ã€ä»£ç å®ç°å’Œéƒ¨ç½²æ­¥éª¤ã€‚æŒ‰ç…§æœ¬æ¸…å•å¯ä»¥å®Œæ•´å¤ç°æ•´ä¸ªé¡¹ç›®ã€‚

---

## ğŸ¯ ç³»ç»Ÿéœ€æ±‚

### åŠŸèƒ½éœ€æ±‚
- ç®¡ç†å‘˜ç™»å½•/æ³¨å†Œç³»ç»Ÿ
- å­¦ç”Ÿä¿¡æ¯å¢åˆ æ”¹æŸ¥
- è¯¾ç¨‹ä¿¡æ¯å¢åˆ æ”¹æŸ¥
- æ•™å¸ˆä¿¡æ¯å¢åˆ æ”¹æŸ¥
- å®æ—¶æœç´¢åŠŸèƒ½
- å“åº”å¼ç•Œé¢è®¾è®¡
- å®Œæ•´ä¸­æ–‡æ”¯æŒ

### æŠ€æœ¯æ ˆ
- å‰ç«¯ï¼šHTML5 + CSS3 + JavaScriptï¼ˆåŸç”Ÿï¼‰
- åç«¯ï¼šNetlify Functionsï¼ˆServerlessï¼‰
- æ•°æ®åº“ï¼šNeon PostgreSQLï¼ˆServerlessï¼‰
- éƒ¨ç½²ï¼šNetlify
- è®¤è¯ï¼šJWT + bcrypt

---

## ğŸ“ ç¬¬ä¸€æ­¥ï¼šé¡¹ç›®åˆå§‹åŒ–

### 1.1 åˆ›å»ºé¡¹ç›®ç›®å½•

```powershell
# åˆ›å»ºå¹¶è¿›å…¥é¡¹ç›®ç›®å½•
mkdir studenthtmlnetlify
cd studenthtmlnetlify
```

### 1.2 åˆå§‹åŒ– npm é¡¹ç›®

```powershell
npm init -y
```

### 1.3 å®‰è£…ä¾èµ–åŒ…

```powershell
npm install pg bcryptjs jsonwebtoken dotenv
```

**ä¾èµ–è¯´æ˜ï¼š**
- `pg` - PostgreSQL å®¢æˆ·ç«¯ï¼Œç”¨äºè¿æ¥ Neon æ•°æ®åº“
- `bcryptjs` - å¯†ç åŠ å¯†åº“
- `jsonwebtoken` - JWT token ç”Ÿæˆå’ŒéªŒè¯
- `dotenv` - ç¯å¢ƒå˜é‡ç®¡ç†

### 1.4 åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„

```powershell
mkdir src
mkdir netlify\functions
mkdir netlify\functions\_shared
mkdir scripts
```

**ç›®å½•è¯´æ˜ï¼š**
```
studenthtmlnetlify/
â”œâ”€â”€ src/                          # å‰ç«¯é™æ€æ–‡ä»¶
â”œâ”€â”€ netlify/
â”‚   â””â”€â”€ functions/               # Serverless API
â”‚       â””â”€â”€ _shared/            # å…±äº«å·¥å…·æ¨¡å—
â”œâ”€â”€ scripts/                     # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ netlify.toml                # Netlify é…ç½®
â”œâ”€â”€ package.json                # ä¾èµ–ç®¡ç†
â””â”€â”€ env.example                 # ç¯å¢ƒå˜é‡æ¨¡æ¿
```

---

## ğŸ“ ç¬¬äºŒæ­¥ï¼šé…ç½®æ–‡ä»¶åˆ›å»º

### 2.1 åˆ›å»º `package.json`

```json
{
  "name": "studenthtmlnetlify",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "dev": "netlify dev",
    "test": "echo \"Error: no test specified\" && exit 1",
    "build:noop": "echo \"Nothing to build\""
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/bistuwangqiyuan/studenthtmlnetlify.git"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "description": "",
  "dependencies": {
    "bcryptjs": "^3.0.3",
    "dotenv": "^17.2.3",
    "jsonwebtoken": "^9.0.2",
    "pg": "^8.16.3"
  }
}
```

### 2.2 åˆ›å»º `netlify.toml`

```toml
[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/:splat"
  status = 200

[build]
  publish = "src"
  command = "echo 'Static site - no build required'"

[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"

[build.environment]
  NODE_VERSION = "18"
```

**é…ç½®è¯´æ˜ï¼š**
- `redirects` - å°† `/api/*` è·¯å¾„é‡å®šå‘åˆ° Netlify Functions
- `publish` - é™æ€æ–‡ä»¶å‘å¸ƒç›®å½•ä¸º `src`
- `functions` - Functions ç›®å½•å’Œæ‰“åŒ…æ–¹å¼
- `NODE_VERSION` - æŒ‡å®š Node.js ç‰ˆæœ¬

### 2.3 åˆ›å»º `env.example`

```env
NEON_DATABASE_URL=postgresql://user:password@host:5432/database?sslmode=require
JWT_SECRET=your-super-secret-random-string-at-least-32-chars
```

---

## ğŸ”§ ç¬¬ä¸‰æ­¥ï¼šåç«¯ API å¼€å‘

### 3.1 åˆ›å»ºå…±äº«æ¨¡å—

#### `netlify/functions/_shared/db.js`

```javascript
const { Pool } = require('pg');

let pool;

const createPool = () => {
  const connectionString = process.env.NEON_DATABASE_URL;
  if (!connectionString) {
    throw new Error('Environment variable NEON_DATABASE_URL is not set.');
  }

  return new Pool({
    connectionString,
    max: 5,
    idleTimeoutMillis: 30000,
    connectionTimeoutMillis: 10000,
    ssl: {
      rejectUnauthorized: false,
    },
  });
};

const getPool = () => {
  if (!pool) {
    pool = createPool();
  }
  return pool;
};

const query = async (text, params = []) => {
  const client = await getPool().connect();
  try {
    return await client.query(text, params);
  } finally {
    client.release();
  }
};

module.exports = {
  query,
};
```

#### `netlify/functions/_shared/http.js`

```javascript
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'Content-Type, Authorization',
  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
  'Access-Control-Max-Age': '86400',
  'Content-Type': 'application/json; charset=utf-8',
};

const okResponse = (body, statusCode = 200) => ({
  statusCode,
  headers: corsHeaders,
  body: JSON.stringify(body),
});

const errorResponse = (statusCode, message) => ({
  statusCode,
  headers: corsHeaders,
  body: JSON.stringify({
    error: message,
  }),
});

const handleOptions = () => ({
  statusCode: 204,
  headers: corsHeaders,
  body: '',
});

const parseJsonBody = (event) => {
  if (!event.body) {
    return {};
  }

  try {
    return JSON.parse(event.body);
  } catch (error) {
    throw new Error('Invalid JSON payload.');
  }
};

const getPathSegments = (event) =>
  event.path
    .replace('/.netlify/functions', '')
    .split('/')
    .filter(Boolean);

module.exports = {
  corsHeaders,
  okResponse,
  errorResponse,
  handleOptions,
  parseJsonBody,
  getPathSegments,
};
```

**å…³é”®ç‚¹ï¼š**
- æ·»åŠ äº† `Content-Type: application/json; charset=utf-8` ç¡®ä¿ä¸­æ–‡ä¸ä¹±ç 
- CORS é…ç½®å…è®¸è·¨åŸŸè®¿é—®

#### `netlify/functions/_shared/auth.js`

```javascript
const jwt = require('jsonwebtoken');

const JWT_SECRET = process.env.JWT_SECRET;

if (!JWT_SECRET) {
  throw new Error('Environment variable JWT_SECRET is not set.');
}

const signToken = (payload) => {
  return jwt.sign(payload, JWT_SECRET, {
    expiresIn: '7d',
  });
};

const verifyToken = (event) => {
  const authHeader = event.headers.authorization || event.headers.Authorization;

  if (!authHeader) {
    const error = new Error('Authorization token is required.');
    error.statusCode = 401;
    throw error;
  }

  const token = authHeader.replace(/^Bearer\s+/i, '');

  try {
    return jwt.verify(token, JWT_SECRET);
  } catch (err) {
    const error = new Error('Invalid or expired token.');
    error.statusCode = 401;
    throw error;
  }
};

module.exports = {
  signToken,
  verifyToken,
};
```

### 3.2 åˆ›å»ºè®¤è¯ API

#### `netlify/functions/auth.js`

```javascript
const bcrypt = require('bcryptjs');
const { query } = require('./_shared/db');
const {
  okResponse,
  errorResponse,
  handleOptions,
  parseJsonBody,
} = require('./_shared/http');
const { signToken, verifyToken } = require('./_shared/auth');

const normalizeAdmin = (row) => ({
  id: row.id,
  username: row.username,
  createdAt: row.created_at,
});

exports.handler = async (event) => {
  try {
    if (event.httpMethod === 'OPTIONS') {
      return handleOptions();
    }

    // ä»è·¯å¾„ä¸­æå–æ“ä½œï¼š/api/auth/login -> login
    const path = event.path || '';
    const action = path.split('/').filter(Boolean).pop() || 'login';

    if (event.httpMethod === 'POST' && action === 'login') {
      const { username, password } = parseJsonBody(event);

      if (!username || !password) {
        return errorResponse(400, 'Username and password are required.');
      }

      const { rows } = await query(
        'SELECT id, username, password_hash, created_at FROM administrators WHERE username = $1',
        [username.trim()]
      );

      if (rows.length === 0) {
        return errorResponse(401, 'Invalid username or password.');
      }

      const admin = rows[0];
      const isMatch = await bcrypt.compare(password, admin.password_hash);

      if (!isMatch) {
        return errorResponse(401, 'Invalid username or password.');
      }

      const token = signToken({ sub: admin.id, username: admin.username });

      return okResponse({
        token,
        admin: normalizeAdmin(admin),
      });
    }

    if (event.httpMethod === 'POST' && action === 'register') {
      const { username, password } = parseJsonBody(event);

      if (!username || !password) {
        return errorResponse(400, 'Username and password are required.');
      }

      const countResult = await query('SELECT COUNT(*)::int AS count FROM administrators');
      const adminCount = countResult.rows[0].count;

      if (adminCount > 0) {
        try {
          verifyToken(event);
        } catch (authError) {
          const status = authError.statusCode || 401;
          return errorResponse(status, authError.message);
        }
      }

      const existing = await query('SELECT 1 FROM administrators WHERE username = $1', [
        username.trim(),
      ]);

      if (existing.rows.length > 0) {
        return errorResponse(409, 'Username already exists.');
      }

      const passwordHash = await bcrypt.hash(password, 10);
      const insertResult = await query(
        `INSERT INTO administrators (username, password_hash)
         VALUES ($1, $2)
         RETURNING id, username, created_at`,
        [username.trim(), passwordHash]
      );
      const admin = insertResult.rows[0];

      return okResponse({
        admin: normalizeAdmin(admin),
      }, 201);
    }

    if (event.httpMethod === 'GET' && action === 'me') {
      let tokenPayload;
      try {
        tokenPayload = verifyToken(event);
      } catch (authError) {
        const status = authError.statusCode || 401;
        return errorResponse(status, authError.message);
      }

      const { rows } = await query(
        'SELECT id, username, created_at FROM administrators WHERE id = $1',
        [tokenPayload.sub]
      );

      if (rows.length === 0) {
        return errorResponse(404, 'Administrator not found.');
      }

      return okResponse({
        admin: normalizeAdmin(rows[0]),
      });
    }

    return errorResponse(404, 'Not found.');
  } catch (error) {
    console.error('Auth handler error:', error);
    const statusCode = error.statusCode || 500;
    return errorResponse(statusCode, statusCode === 500 ? 'Internal server error.' : error.message);
  }
};
```

**å…³é”®ä¿®æ”¹ï¼š**
- è·¯å¾„è§£ææ”¹ä¸ºï¼š`const action = path.split('/').filter(Boolean).pop() || 'login';`
- æ”¯æŒ `/api/auth/login` è¿™æ ·çš„è·¯å¾„æ ¼å¼

### 3.3 åˆ›å»ºå­¦ç”Ÿ API

#### `netlify/functions/students.js`

*ï¼ˆç”±äºç¯‡å¹…é™åˆ¶ï¼Œè¿™é‡Œåªåˆ—å‡ºå…³é”®ç»“æ„ï¼Œå®Œæ•´ä»£ç è§é¡¹ç›®æ–‡ä»¶ï¼‰*

```javascript
const { query } = require('./_shared/db');
const { okResponse, errorResponse, handleOptions, parseJsonBody, getPathSegments } = require('./_shared/http');
const { verifyToken } = require('./_shared/auth');

const normalizeStudent = (row) => ({ /* ... */ });
const ensureAuthenticated = (event) => { /* ... */ };

exports.handler = async (event) => {
  // GET /students - è·å–æ‰€æœ‰å­¦ç”Ÿ
  // GET /students?search=keyword - æœç´¢å­¦ç”Ÿ
  // POST /students - æ–°å¢å­¦ç”Ÿ
  // PUT /students/:id - æ›´æ–°å­¦ç”Ÿ
  // DELETE /students/:id - åˆ é™¤å­¦ç”Ÿ
};
```

### 3.4 åˆ›å»ºè¯¾ç¨‹å’Œæ•™å¸ˆ API

æŒ‰ç…§ç±»ä¼¼ `students.js` çš„ç»“æ„åˆ›å»ºï¼š
- `netlify/functions/courses.js`
- `netlify/functions/teachers.js`

---

## ğŸ—„ï¸ ç¬¬å››æ­¥ï¼šæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

### 4.1 åˆ›å»º `scripts/init-db.js`

```javascript
/* eslint-disable no-console */
require('dotenv').config();
const bcrypt = require('bcryptjs');
const { Pool } = require('pg');

const connectionString = process.env.NEON_DATABASE_URL;

if (!connectionString) {
  console.error('Missing NEON_DATABASE_URL in environment.');
  process.exit(1);
}

const pool = new Pool({
  connectionString,
  ssl: {
    rejectUnauthorized: false,
  },
});

const run = async () => {
  try {
    console.log('ğŸ”§ Initialising database schema...');

    await pool.query('CREATE EXTENSION IF NOT EXISTS "pgcrypto";');

    // åˆ›å»ºç®¡ç†å‘˜è¡¨
    await pool.query(`
      CREATE TABLE IF NOT EXISTS administrators (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        username TEXT NOT NULL UNIQUE,
        password_hash TEXT NOT NULL,
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
      );
    `);

    // åˆ›å»ºå­¦ç”Ÿè¡¨
    await pool.query(`
      CREATE TABLE IF NOT EXISTS students (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        student_number TEXT NOT NULL UNIQUE,
        name TEXT NOT NULL,
        gender TEXT,
        age INT,
        major TEXT,
        class_name TEXT,
        contact TEXT,
        notes TEXT,
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
      );
    `);

    // åˆ›å»ºè¯¾ç¨‹è¡¨
    await pool.query(`
      CREATE TABLE IF NOT EXISTS courses (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        course_code TEXT NOT NULL UNIQUE,
        name TEXT NOT NULL,
        credit_hours INT,
        teacher TEXT,
        description TEXT,
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
      );
    `);

    // åˆ›å»ºæ•™å¸ˆè¡¨
    await pool.query(`
      CREATE TABLE IF NOT EXISTS teachers (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        teacher_code TEXT NOT NULL UNIQUE,
        name TEXT NOT NULL,
        title TEXT,
        email TEXT,
        phone TEXT,
        department TEXT,
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
      );
    `);

    console.log('âœ… Tables ensured.');

    // åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜
    const defaultAdminUsername = 'admin';
    const defaultAdminPassword = 'admin';

    const { rows: adminExists } = await pool.query(
      'SELECT 1 FROM administrators WHERE username = $1',
      [defaultAdminUsername]
    );

    if (adminExists.length === 0) {
      const passwordHash = await bcrypt.hash(defaultAdminPassword, 10);
      await pool.query(
        `INSERT INTO administrators (username, password_hash)
         VALUES ($1, $2);`,
        [defaultAdminUsername, passwordHash]
      );
      console.log('ğŸ‘¤ Default administrator account created (admin/admin).');
    } else {
      console.log('ğŸ‘¤ Default administrator already exists.');
    }

    // æ’å…¥ç¤ºä¾‹å­¦ç”Ÿæ•°æ®
    const { rows: studentCountRows } = await pool.query(
      'SELECT COUNT(*)::int AS count FROM students;'
    );

    if (studentCountRows[0].count === 0) {
      await pool.query(`
        INSERT INTO students
          (student_number, name, gender, age, major, class_name, contact, notes)
        VALUES
          ('2023001', 'å¼ ä¼Ÿ', 'ç”·', 20, 'è®¡ç®—æœºç§‘å­¦', 'è®¡ç§‘2301', '13800001111', 'çƒ­çˆ±ç¼–ç¨‹'),
          ('2023002', 'æå¨œ', 'å¥³', 19, 'è½¯ä»¶å·¥ç¨‹', 'è½¯å·¥2302', '13900002222', 'å­¦ç”Ÿä¼šæˆå‘˜'),
          ('2023003', 'ç‹å¼º', 'ç”·', 21, 'ä¿¡æ¯ç®¡ç†', 'ä¿¡ç®¡2301', '13700003333', 'å–œæ¬¢ç¯®çƒ');
      `);
      console.log('ğŸ“ Seeded sample students.');
    }

    // æ’å…¥ç¤ºä¾‹è¯¾ç¨‹æ•°æ®
    const { rows: courseCountRows } = await pool.query(
      'SELECT COUNT(*)::int AS count FROM courses;'
    );

    if (courseCountRows[0].count === 0) {
      await pool.query(`
        INSERT INTO courses
          (course_code, name, credit_hours, teacher, description)
        VALUES
          ('CS101', 'ç¨‹åºè®¾è®¡åŸºç¡€', 4, 'èµµè€å¸ˆ', 'C è¯­è¨€çš„åŸºç¡€è¯­æ³•ä¸ç¨‹åºè®¾è®¡æ€ç»´'),
          ('CS205', 'æ•°æ®ç»“æ„', 3, 'é’±è€å¸ˆ', 'çº¿æ€§è¡¨ã€æ ‘ä¸å›¾çš„ç»“æ„ä¸ç®—æ³•'),
          ('CS310', 'Web å¼€å‘', 3, 'å­™è€å¸ˆ', 'å‰ç«¯ä¸åç«¯çš„ç»¼åˆå®è·µè¯¾ç¨‹');
      `);
      console.log('ğŸ“š Seeded sample courses.');
    }

    // æ’å…¥ç¤ºä¾‹æ•™å¸ˆæ•°æ®
    const { rows: teacherCountRows } = await pool.query(
      'SELECT COUNT(*)::int AS count FROM teachers;'
    );

    if (teacherCountRows[0].count === 0) {
      await pool.query(`
        INSERT INTO teachers
          (teacher_code, name, title, email, phone, department)
        VALUES
          ('T001', 'èµµè€å¸ˆ', 'æ•™æˆ', 'zhao@example.com', '13600004444', 'è®¡ç®—æœºå­¦é™¢'),
          ('T002', 'é’±è€å¸ˆ', 'å‰¯æ•™æˆ', 'qian@example.com', '13500005555', 'è½¯ä»¶å­¦é™¢'),
          ('T003', 'å­™è€å¸ˆ', 'è®²å¸ˆ', 'sun@example.com', '13400006666', 'ä¿¡æ¯å­¦é™¢');
      `);
      console.log('ğŸ‘©â€ğŸ« Seeded sample teachers.');
    }

    console.log('âœ… Database initialisation completed successfully.');
  } catch (error) {
    console.error('âŒ Database initialisation failed:', error);
    process.exitCode = 1;
  } finally {
    await pool.end();
  }
};

run();
```

---

## ğŸ¨ ç¬¬äº”æ­¥ï¼šå‰ç«¯å¼€å‘

### 5.1 åˆ›å»º `src/index.html`

*ï¼ˆç”±äºç¯‡å¹…é™åˆ¶ï¼Œè¿™é‡Œåªåˆ—å‡ºå…³é”®ç»“æ„ï¼‰*

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <div class="app">
        <header class="app-header">
            <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        </header>
        
        <main class="app-main">
            <!-- ç™»å½•/æ³¨å†ŒåŒºåŸŸ -->
            <section class="auth-section" id="auth-section">
                <!-- ç™»å½•è¡¨å• -->
                <!-- æ³¨å†Œè¡¨å• -->
            </section>
            
            <!-- ç®¡ç†é¢æ¿ -->
            <section class="dashboard hidden" id="dashboard">
                <!-- å­¦ç”Ÿä¿¡æ¯ç®¡ç† -->
                <!-- è¯¾ç¨‹ä¿¡æ¯ç®¡ç† -->
                <!-- æ•™å¸ˆä¿¡æ¯ç®¡ç† -->
            </section>
        </main>
        
        <footer class="app-footer">
            <!-- é¡µè„šä¿¡æ¯ -->
        </footer>
    </div>
    
    <script src="app.js"></script>
</body>
</html>
```

### 5.2 åˆ›å»º `src/styles.css`

*ï¼ˆåŒ…å«å®Œæ•´çš„å“åº”å¼æ ·å¼ã€åŠ¨ç”»æ•ˆæœç­‰ï¼Œè§é¡¹ç›®æ–‡ä»¶ï¼‰*

### 5.3 åˆ›å»º `src/app.js`

*ï¼ˆåŒ…å«å®Œæ•´çš„å‰ç«¯é€»è¾‘ã€APIè°ƒç”¨ã€çŠ¶æ€ç®¡ç†ç­‰ï¼Œè§é¡¹ç›®æ–‡ä»¶ï¼‰*

---

## ğŸš€ ç¬¬å…­æ­¥ï¼šNetlify éƒ¨ç½²é…ç½®

### 6.1 å®‰è£… Netlify CLI

```powershell
npm install -g netlify-cli
```

### 6.2 ç™»å½• Netlify

```powershell
netlify login
```

æµè§ˆå™¨ä¼šæ‰“å¼€æˆæƒé¡µé¢ï¼Œæˆæƒåè¿”å›ç»ˆç«¯ã€‚

### 6.3 å–æ¶ˆé“¾æ¥æ—§ç«™ç‚¹ï¼ˆå¦‚æœæœ‰ï¼‰

```powershell
netlify unlink
```

### 6.4 é“¾æ¥åˆ°æ–°ç«™ç‚¹

```powershell
netlify link --name studenthtmlnetlify
```

**æˆ–è€…åˆå§‹åŒ–æ–°ç«™ç‚¹ï¼š**

```powershell
netlify init
```

æŒ‰æç¤ºé€‰æ‹©å›¢é˜Ÿå’Œåˆ›å»ºæ–°ç«™ç‚¹ã€‚

---

## ğŸ” ç¬¬ä¸ƒæ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡

### 7.1 è·å– Neon æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²

1. ç™»å½• Neon æ§åˆ¶å°ï¼šhttps://console.neon.tech/
2. åˆ›å»ºæˆ–é€‰æ‹©æ•°æ®åº“é¡¹ç›®
3. å¤åˆ¶è¿æ¥å­—ç¬¦ä¸²ï¼ˆPooled Connection Stringï¼‰

ç¤ºä¾‹æ ¼å¼ï¼š
```
postgresql://user:password@host-pooler.region.aws.neon.tech/dbname?sslmode=require
```

### 7.2 åœ¨ Netlify è®¾ç½®ç¯å¢ƒå˜é‡

```powershell
# è®¾ç½®æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
netlify env:set NEON_DATABASE_URL "postgresql://neondb_owner:npg_38JLlWFQBsiE@ep-steep-dawn-aezok0a9-pooler.c-2.us-east-2.aws.neon.tech/neondb?channel_binding=require&sslmode=require"

# è®¾ç½® JWT å¯†é’¥ï¼ˆç”Ÿæˆä¸€ä¸ªéšæœºå­—ç¬¦ä¸²ï¼‰
netlify env:set JWT_SECRET "sk_prod_8a7f2e9c4d1b6a3e5f8c2d9a7b4e1c3f6a9b2d5e8c1f4a7b3e6c9d2f5a8b1e4c7"
```

### 7.3 éªŒè¯ç¯å¢ƒå˜é‡

```powershell
netlify env:list
```

åº”è¯¥çœ‹åˆ°ï¼š
```
NEON_DATABASE_URL  | postgresql://...  | All
JWT_SECRET         | sk_prod_...       | All
```

---

## ğŸ—„ï¸ ç¬¬å…«æ­¥ï¼šåˆå§‹åŒ–æ•°æ®åº“

### 8.1 åˆ›å»ºæœ¬åœ° .env æ–‡ä»¶ï¼ˆç”¨äºåˆå§‹åŒ–è„šæœ¬ï¼‰

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
NEON_DATABASE_URL=postgresql://neondb_owner:npg_38JLlWFQBsiE@ep-steep-dawn-aezok0a9-pooler.c-2.us-east-2.aws.neon.tech/neondb?channel_binding=require&sslmode=require
JWT_SECRET=sk_prod_8a7f2e9c4d1b6a3e5f8c2d9a7b4e1c3f6a9b2d5e8c1f4a7b3e6c9d2f5a8b1e4c7
```

**æ³¨æ„ï¼š** `.env` æ–‡ä»¶ä¸åº”æäº¤åˆ° Gitï¼Œåº”æ·»åŠ åˆ° `.gitignore`

### 8.2 è¿è¡Œåˆå§‹åŒ–è„šæœ¬

```powershell
node scripts/init-db.js
```

**é¢„æœŸè¾“å‡ºï¼š**
```
ğŸ”§ Initialising database schema...
âœ… Tables ensured.
ğŸ‘¤ Default administrator account created (admin/admin).
ğŸ“ Seeded sample students.
ğŸ“š Seeded sample courses.
ğŸ‘©â€ğŸ« Seeded sample teachers.
âœ… Database initialisation completed successfully.
```

---

## ğŸš€ ç¬¬ä¹æ­¥ï¼šéƒ¨ç½²åˆ° Netlify

### 9.1 é¦–æ¬¡éƒ¨ç½²

```powershell
netlify deploy --prod
```

**éƒ¨ç½²è¿‡ç¨‹ï¼š**
1. Netlify Build å¼€å§‹
2. è¿è¡Œæ„å»ºå‘½ä»¤ï¼ˆecho 'Static site - no build required'ï¼‰
3. æ‰“åŒ… Functionsï¼ˆauth, students, courses, teachersï¼‰
4. ä¸Šä¼ é™æ€æ–‡ä»¶å’Œ Functions
5. ç­‰å¾…éƒ¨ç½²ä¸Šçº¿

**é¢„æœŸè¾“å‡ºï¼š**
```
ğŸš€ Deploy complete
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Deployed to production URL: https://studenthtmlnetlify.netlify.app
```

### 9.2 è®°å½•ç«™ç‚¹ URL

éƒ¨ç½²æˆåŠŸåï¼Œè®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š
- **ç”Ÿäº§ URLï¼š** https://studenthtmlnetlify.netlify.app
- **Admin URLï¼š** https://app.netlify.com/sites/studenthtmlnetlify
- **Function Logsï¼š** https://app.netlify.com/sites/studenthtmlnetlify/logs/functions

---

## âœ… ç¬¬åæ­¥ï¼šæµ‹è¯•éƒ¨ç½²ç»“æœ

### 10.1 è®¿é—®ç½‘ç«™

æµè§ˆå™¨æ‰“å¼€ï¼šhttps://studenthtmlnetlify.netlify.app

### 10.2 æµ‹è¯•ç™»å½•åŠŸèƒ½

1. ä½¿ç”¨é»˜è®¤è´¦å·ç™»å½•ï¼š
   - ç”¨æˆ·åï¼š`admin`
   - å¯†ç ï¼š`admin`

2. éªŒè¯ç™»å½•æˆåŠŸ
   - çœ‹åˆ°ç®¡ç†é¢æ¿
   - é¡¶éƒ¨æ˜¾ç¤ºç”¨æˆ·å

### 10.3 æµ‹è¯•å­¦ç”Ÿç®¡ç†åŠŸèƒ½

1. æŸ¥çœ‹å­¦ç”Ÿåˆ—è¡¨ï¼ˆåº”è¯¥æœ‰ 3 æ¡ç¤ºä¾‹æ•°æ®ï¼‰
2. æœç´¢å­¦ç”Ÿï¼ˆè¾“å…¥"å¼ ä¼Ÿ"æˆ–"è®¡ç®—æœº"ï¼‰
3. æ–°å¢å­¦ç”Ÿï¼š
   ```
   å­¦å·ï¼š2024001
   å§“åï¼šæµ‹è¯•å­¦ç”Ÿ
   æ€§åˆ«ï¼šç”·
   å¹´é¾„ï¼š20
   ä¸“ä¸šï¼šè®¡ç®—æœºç§‘å­¦
   ç­çº§ï¼šè®¡ç§‘2401
   è”ç³»æ–¹å¼ï¼š13800138000
   å¤‡æ³¨ï¼šæµ‹è¯•æ•°æ®
   ```
4. ç¼–è¾‘å­¦ç”Ÿï¼ˆç‚¹å‡»"ç¼–è¾‘"æŒ‰é’®ï¼‰
5. åˆ é™¤å­¦ç”Ÿï¼ˆç‚¹å‡»"åˆ é™¤"æŒ‰é’®ï¼‰

### 10.4 æµ‹è¯•è¯¾ç¨‹å’Œæ•™å¸ˆç®¡ç†

åˆ‡æ¢åˆ°å¯¹åº”æ ‡ç­¾ï¼Œæµ‹è¯•å¢åˆ æ”¹æŸ¥åŠŸèƒ½ã€‚

### 10.5 æµ‹è¯•ä¸­æ–‡ç¼–ç 

ç¡®è®¤æ‰€æœ‰ä¸­æ–‡æ˜¾ç¤ºæ­£å¸¸ï¼Œæ— ä¹±ç ã€‚

### 10.6 æµ‹è¯•å“åº”å¼è®¾è®¡

æŒ‰ F12ï¼Œåˆ‡æ¢åˆ°è®¾å¤‡å·¥å…·æ ï¼Œæµ‹è¯•æ‰‹æœºè§†å›¾ã€‚

---

## ğŸ”§ å…³é”®æŠ€æœ¯ç»†èŠ‚

### 1. è·¯å¾„å¤„ç†ä¿®å¤

**é—®é¢˜ï¼š** åˆå§‹éƒ¨ç½²æ—¶ API è¿”å› 404

**åŸå› ï¼š** Netlify Functions çš„è·¯å¾„å¤„ç†é—®é¢˜

**è§£å†³æ–¹æ¡ˆï¼š** åœ¨ `auth.js` ä¸­ä¿®æ”¹è·¯å¾„è§£æé€»è¾‘

```javascript
// ä¿®æ”¹å‰
const segments = getPathSegments(event);
const action = segments[1] || '';

// ä¿®æ”¹å
const path = event.path || '';
const action = path.split('/').filter(Boolean).pop() || 'login';
```

### 2. ä¸­æ–‡ç¼–ç æ”¯æŒ

**å…³é”®é…ç½®ï¼š**

1. HTML meta æ ‡ç­¾ï¼š
```html
<meta charset="UTF-8" />
```

2. API å“åº”å¤´ï¼š
```javascript
'Content-Type': 'application/json; charset=utf-8'
```

3. æ•°æ®åº“è¿æ¥ï¼šç¡®ä¿ä½¿ç”¨ UTF-8 ç¼–ç 

### 3. CORS é…ç½®

```javascript
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'Content-Type, Authorization',
  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
  'Access-Control-Max-Age': '86400',
};
```

### 4. JWT è®¤è¯æµç¨‹

1. ç”¨æˆ·ç™»å½• â†’ åç«¯éªŒè¯å¯†ç  â†’ ç”Ÿæˆ JWT token
2. å‰ç«¯å­˜å‚¨ token åˆ° localStorage
3. åç»­è¯·æ±‚æºå¸¦ tokenï¼š`Authorization: Bearer <token>`
4. åç«¯éªŒè¯ token â†’ æ‰§è¡Œæ“ä½œ

### 5. æ•°æ®åº“è¿æ¥æ± 

ä½¿ç”¨è¿æ¥æ± ä¼˜åŒ–æ•°æ®åº“æ€§èƒ½ï¼š
```javascript
const pool = new Pool({
  connectionString,
  max: 5,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 10000,
});
```

---

## ğŸ“Š é¡¹ç›®æ–‡ä»¶æ¸…å•

### å¿…éœ€æ–‡ä»¶

```
âœ… package.json                    - npm é…ç½®å’Œä¾èµ–
âœ… netlify.toml                    - Netlify é…ç½®
âœ… env.example                     - ç¯å¢ƒå˜é‡æ¨¡æ¿
âœ… scripts/init-db.js              - æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
âœ… src/index.html                  - å‰ç«¯ä¸»é¡µé¢
âœ… src/styles.css                  - å‰ç«¯æ ·å¼
âœ… src/app.js                      - å‰ç«¯é€»è¾‘
âœ… netlify/functions/_shared/db.js    - æ•°æ®åº“è¿æ¥
âœ… netlify/functions/_shared/http.js  - HTTP å·¥å…·
âœ… netlify/functions/_shared/auth.js  - JWT è®¤è¯
âœ… netlify/functions/auth.js       - è®¤è¯ API
âœ… netlify/functions/students.js   - å­¦ç”Ÿ API
âœ… netlify/functions/courses.js    - è¯¾ç¨‹ API
âœ… netlify/functions/teachers.js   - æ•™å¸ˆ API
```

### å¯é€‰æ–‡ä»¶

```
ğŸ“„ README.md                      - é¡¹ç›®è¯´æ˜
ğŸ“„ test-api.js                    - API æµ‹è¯•è„šæœ¬
ğŸ“„ .gitignore                     - Git å¿½ç•¥æ–‡ä»¶
```

---

## ğŸ› å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1ï¼šéƒ¨ç½²å¤±è´¥ "Next.js build output not found"

**åŸå› ï¼š** Netlify ç«™ç‚¹å¯ç”¨äº† Next.js æ’ä»¶

**è§£å†³æ–¹æ¡ˆï¼š**
1. è®¿é—® https://app.netlify.com/sites/ä½ çš„ç«™ç‚¹å/configuration/integrations
2. å¸è½½ `@netlify/plugin-nextjs` æ’ä»¶
3. é‡æ–°éƒ¨ç½²

### é—®é¢˜ 2ï¼šAPI è¿”å› 404

**åŸå› ï¼š** Functions è·¯å¾„å¤„ç†é—®é¢˜

**è§£å†³æ–¹æ¡ˆï¼š** ä½¿ç”¨ä¿®æ”¹åçš„è·¯å¾„è§£æé€»è¾‘ï¼ˆè§"å…³é”®æŠ€æœ¯ç»†èŠ‚"ï¼‰

### é—®é¢˜ 3ï¼šç™»å½•å¤±è´¥ "Environment variable not set"

**åŸå› ï¼š** ç¯å¢ƒå˜é‡æœªé…ç½®

**è§£å†³æ–¹æ¡ˆï¼š**
```powershell
netlify env:list  # æ£€æŸ¥ç¯å¢ƒå˜é‡
netlify env:set NEON_DATABASE_URL "..."
netlify env:set JWT_SECRET "..."
```

### é—®é¢˜ 4ï¼šä¸­æ–‡æ˜¾ç¤ºä¹±ç 

**åŸå› ï¼š** å“åº”å¤´ç¼ºå°‘ charset

**è§£å†³æ–¹æ¡ˆï¼š** ç¡®ä¿å“åº”å¤´åŒ…å« `charset=utf-8`

### é—®é¢˜ 5ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥

**åŸå› ï¼š** è¿æ¥å­—ç¬¦ä¸²é”™è¯¯æˆ–ç½‘ç»œé—®é¢˜

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥ Neon æ•°æ®åº“æ˜¯å¦åœ¨çº¿
2. éªŒè¯è¿æ¥å­—ç¬¦ä¸²æ˜¯å¦æ­£ç¡®
3. ç¡®è®¤ä½¿ç”¨ Pooled Connection String

---

## ğŸ“ˆ éƒ¨ç½²åç»´æŠ¤

### 1. æ›´æ–°ä»£ç 

```powershell
# ä¿®æ”¹ä»£ç å
netlify deploy --prod
```

### 2. æŸ¥çœ‹å‡½æ•°æ—¥å¿—

è®¿é—®ï¼šhttps://app.netlify.com/sites/studenthtmlnetlify/logs/functions

### 3. æŸ¥çœ‹éƒ¨ç½²å†å²

è®¿é—®ï¼šhttps://app.netlify.com/sites/studenthtmlnetlify/deploys

### 4. ä¿®æ”¹ç¯å¢ƒå˜é‡

```powershell
netlify env:set å˜é‡å "æ–°å€¼"
```

### 5. å¤‡ä»½æ•°æ®åº“

å®šæœŸå¯¼å‡º Neon æ•°æ®åº“æ•°æ®ã€‚

---

## ğŸ”’ å®‰å…¨å»ºè®®

### 1. ä¿®æ”¹é»˜è®¤å¯†ç 

**é‡è¦ï¼** éƒ¨ç½²åç«‹å³ï¼š
1. åˆ›å»ºæ–°çš„ç®¡ç†å‘˜è´¦å·
2. ä½¿ç”¨å¼ºå¯†ç 
3. åˆ é™¤æˆ–ä¿®æ”¹é»˜è®¤ admin/admin è´¦å·

### 2. ä¿æŠ¤ç¯å¢ƒå˜é‡

- ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
- ä¸è¦æäº¤ `.env` æ–‡ä»¶åˆ° Git
- å®šæœŸæ›´æ¢ JWT_SECRET

### 3. æ›´æ–°ä¾èµ–åŒ…

```powershell
npm update
npm audit fix
```

### 4. ç›‘æ§è®¿é—®æ—¥å¿—

å®šæœŸæ£€æŸ¥ Netlify å‡½æ•°æ—¥å¿—ï¼Œå‘ç°å¼‚å¸¸è®¿é—®ã€‚

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

éƒ¨ç½²æˆåŠŸåï¼Œç³»ç»Ÿåº”æ»¡è¶³ï¼š

âœ… **åŠŸèƒ½å®Œæ•´æ€§**
- [x] ç®¡ç†å‘˜å¯ä»¥ç™»å½•/æ³¨å†Œ
- [x] å¯ä»¥å¢åˆ æ”¹æŸ¥å­¦ç”Ÿä¿¡æ¯
- [x] å¯ä»¥å¢åˆ æ”¹æŸ¥è¯¾ç¨‹ä¿¡æ¯
- [x] å¯ä»¥å¢åˆ æ”¹æŸ¥æ•™å¸ˆä¿¡æ¯
- [x] æœç´¢åŠŸèƒ½æ­£å¸¸

âœ… **æŠ€æœ¯è¦æ±‚**
- [x] éƒ¨ç½²åœ¨ Netlify
- [x] ä½¿ç”¨ Neon æ•°æ®åº“
- [x] æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨äº‘ç«¯
- [x] API ä½¿ç”¨ Netlify Functions

âœ… **ç”¨æˆ·ä½“éªŒ**
- [x] ä¸­æ–‡æ˜¾ç¤ºæ­£å¸¸æ— ä¹±ç 
- [x] å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒæ‰‹æœºç«¯
- [x] ç•Œé¢ç¾è§‚ï¼Œæ“ä½œæµç•…
- [x] é”™è¯¯æç¤ºæ¸…æ™°

âœ… **å®‰å…¨æ€§**
- [x] å¯†ç åŠ å¯†å­˜å‚¨ï¼ˆbcryptï¼‰
- [x] JWT token è®¤è¯
- [x] API æƒé™éªŒè¯
- [x] HTTPS åŠ å¯†ä¼ è¾“

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ï¼š

1. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12 â†’ Consoleï¼‰
2. æŸ¥çœ‹ç½‘ç»œè¯·æ±‚ï¼ˆF12 â†’ Networkï¼‰
3. æŸ¥çœ‹ Netlify å‡½æ•°æ—¥å¿—
4. å‚è€ƒæœ¬æ–‡æ¡£çš„"å¸¸è§é—®é¢˜"éƒ¨åˆ†

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Netlify Functions æ–‡æ¡£](https://docs.netlify.com/functions/overview/)
- [Neon æ•°æ®åº“æ–‡æ¡£](https://neon.tech/docs)
- [JWT è®¤è¯æŒ‡å—](https://jwt.io/introduction)
- [bcryptjs ä½¿ç”¨æ–‡æ¡£](https://www.npmjs.com/package/bcryptjs)

---

## ğŸ“ ç‰ˆæœ¬å†å²

- **v1.0** (2025-11-09) - åˆå§‹ç‰ˆæœ¬ï¼Œå®ŒæˆåŸºæœ¬åŠŸèƒ½
  - ç®¡ç†å‘˜ç™»å½•/æ³¨å†Œ
  - å­¦ç”Ÿ/è¯¾ç¨‹/æ•™å¸ˆ CRUD
  - æˆåŠŸéƒ¨ç½²åˆ° Netlify

---

## âœ¨ æ€»ç»“

æœ¬é¡¹ç›®ä»é›¶å¼€å§‹æ„å»ºäº†ä¸€ä¸ªå®Œæ•´çš„å­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿï¼Œé‡‡ç”¨ç°ä»£åŒ–çš„ Serverless æ¶æ„ï¼š

- **å‰ç«¯ï¼š** åŸç”Ÿ HTML/CSS/JSï¼Œè½»é‡é«˜æ•ˆ
- **åç«¯ï¼š** Netlify Functionsï¼Œæ— éœ€æœåŠ¡å™¨ç®¡ç†
- **æ•°æ®åº“ï¼š** Neon PostgreSQLï¼Œè‡ªåŠ¨æ‰©ç¼©å®¹
- **éƒ¨ç½²ï¼š** Netlifyï¼Œä¸€é”®éƒ¨ç½²ï¼Œå…¨çƒ CDN åŠ é€Ÿ

ç³»ç»ŸåŠŸèƒ½å®Œæ•´ï¼Œå®‰å…¨å¯é ï¼Œç•Œé¢ç¾è§‚ï¼Œå®Œå…¨æ»¡è¶³å­¦ç”Ÿä¿¡æ¯ç®¡ç†çš„éœ€æ±‚ã€‚

**é¡¹ç›®äº®ç‚¹ï¼š**
- âœ¨ æ— éœ€æœåŠ¡å™¨ï¼Œé›¶è¿ç»´æˆæœ¬
- âœ¨ å…¨çƒ CDN åŠ é€Ÿï¼Œè®¿é—®é€Ÿåº¦å¿«
- âœ¨ è‡ªåŠ¨ HTTPSï¼Œå®‰å…¨å¯é 
- âœ¨ å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒæ‰€æœ‰è®¾å¤‡
- âœ¨ å®Œæ•´çš„ä¸­æ–‡æ”¯æŒï¼Œæ— ä¹±ç 
- âœ¨ ç°ä»£åŒ– UIï¼Œç”¨æˆ·ä½“éªŒå¥½

---

**ğŸ‰ æ­å–œï¼æŒ‰ç…§æœ¬æ¸…å•å®Œæˆæ“ä½œåï¼Œä½ å°†æ‹¥æœ‰ä¸€ä¸ªå®Œå…¨å¯ç”¨çš„å­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿï¼**

